{% extends "base.html" %}

{% block title %}Operations - Nutrient Mixing System{% endblock %}

{% block header_title %}Tank Operations{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Tank Grid -->
    <section class="tanks-section">
        <h2 class="section-title">Tank Status & Operations</h2>
        <div id="tanks-container" class="tanks-grid">
            <div class="loading-placeholder">Loading tank information...</div>
        </div>
    </section>

    <!-- Active Jobs -->
    <section class="jobs-section">
        <h2 class="section-title">Active Jobs</h2>
        <div id="jobs-container" class="jobs-grid">
            <div class="no-jobs">No active jobs</div>
        </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions">
        <h2 class="section-title">Quick Actions</h2>
        <div class="action-grid">
            <button class="action-btn fill-action" onclick="showQuickFill()">
                <span class="action-icon">üíß</span>
                <span class="action-label">Quick Fill</span>
            </button>
            <button class="action-btn mix-action" onclick="showQuickMix()">
                <span class="action-icon">üß™</span>
                <span class="action-label">Quick Mix</span>
            </button>
            <button class="action-btn send-action" onclick="showQuickSend()">
                <span class="action-icon">üöø</span>
                <span class="action-label">Quick Send</span>
            </button>
            <button class="action-btn stop-action" onclick="stopAllOperations()">
                <span class="action-icon">‚èπÔ∏è</span>
                <span class="action-label">Stop All</span>
            </button>
        </div>
    </section>
</div>

<!-- Modal for Quick Actions -->
<div id="action-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Action</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="action-form">
                <div class="form-group">
                    <label for="tank-select">Tank:</label>
                    <select id="tank-select" class="form-control" required>
                        <option value="">Select Tank</option>
                    </select>
                </div>
                <div id="action-fields"></div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Start</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Page-specific variables
    let tanks = {};
    let activeJobs = {};

    // Initialize page
    function initializePage() {
        console.log('Home page initialized');
    }

    // Update page with status
    function updatePageStatus(status) {
        tanks = status.tanks || {};
        activeJobs = status.active_jobs || 0;
        
        updateTanksDisplay();
        updateJobsDisplay();
    }

    // Update tanks display
    function updateTanksDisplay() {
        const container = document.getElementById('tanks-container');
        if (!container) return;

        if (Object.keys(tanks).length === 0) {
            container.innerHTML = '<div class="loading-placeholder">No tanks configured</div>';
            return;
        }

        container.innerHTML = '';

        Object.entries(tanks).forEach(([tankId, tank]) => {
            const tankCard = createTankCard(tankId, tank);
            container.appendChild(tankCard);
        });
    }

    // Create tank card element
    function createTankCard(tankId, tank) {
        const card = document.createElement('div');
        card.className = 'tank-card';
        card.dataset.tankId = tankId;

        const state = tank.state || 'idle';
        const isAvailable = tank.available !== false;
        const activeJobsForTank = tank.active_jobs || [];

        card.innerHTML = `
            <div class="tank-header">
                <div class="tank-name">${tank.name || `Tank ${tankId}`}</div>
                <div class="tank-capacity">${tank.capacity_gallons || 0} gallons</div>
                <div class="tank-state state-${state}">${state.toUpperCase()}</div>
            </div>
            
            <div class="tank-status">
                <div class="status-indicators">
                    <div class="status-indicator ${state === 'filling' ? 'active' : ''}">
                        <div class="indicator-dot"></div>
                        <span>Filling</span>
                    </div>
                    <div class="status-indicator ${state === 'mixing' ? 'active' : ''}">
                        <div class="indicator-dot"></div>
                        <span>Mixing</span>
                    </div>
                    <div class="status-indicator ${state === 'sending' ? 'active' : ''}">
                        <div class="indicator-dot"></div>
                        <span>Sending</span>
                    </div>
                </div>
                
                ${activeJobsForTank.length > 0 ? `
                    <div class="active-jobs">
                        ${activeJobsForTank.map(job => `
                            <div class="job-progress">
                                <div class="job-info">
                                    <span class="job-type">${job.job_type}</span>
                                    <span class="job-progress-text">${job.progress.toFixed(1)}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${job.progress}%"></div>
                                </div>
                                <div class="job-step">${job.step_description}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>

            <div class="tank-controls">
                <button class="control-btn fill-btn ${!isAvailable ? 'disabled' : ''}" 
                        onclick="startFill(${tankId})" ${!isAvailable ? 'disabled' : ''}>
                    Fill Tank
                </button>
                <button class="control-btn mix-btn ${!isAvailable ? 'disabled' : ''}" 
                        onclick="startMix(${tankId})" ${!isAvailable ? 'disabled' : ''}>
                    Mix Nutrients
                </button>
                <button class="control-btn send-btn ${!isAvailable ? 'disabled' : ''}" 
                        onclick="startSend(${tankId})" ${!isAvailable ? 'disabled' : ''}>
                    Send Solution
                </button>
                ${activeJobsForTank.length > 0 ? `
                    <button class="control-btn stop-btn" onclick="stopTankOperations(${tankId})">
                        Stop Operations
                    </button>
                ` : ''}
            </div>
        `;

        return card;
    }

    // Update jobs display
    function updateJobsDisplay() {
        const container = document.getElementById('jobs-container');
        if (!container) return;

        const allActiveJobs = [];
        Object.values(tanks).forEach(tank => {
            if (tank.active_jobs) {
                allActiveJobs.push(...tank.active_jobs.map(job => ({...job, tank_name: tank.name})));
            }
        });

        if (allActiveJobs.length === 0) {
            container.innerHTML = '<div class="no-jobs">No active jobs</div>';
            return;
        }

        container.innerHTML = allActiveJobs.map(job => `
            <div class="job-card">
                <div class="job-header">
                    <span class="job-type">${job.job_type}</span>
                    <span class="job-tank">${job.tank_name}</span>
                </div>
                <div class="job-progress-section">
                    <div class="progress-info">
                        <span class="progress-text">${job.progress.toFixed(1)}%</span>
                        <span class="step-text">${job.step_description}</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${job.progress}%"></div>
                    </div>
                </div>
                <button class="job-cancel-btn" onclick="cancelJob(${job.job_id})">Cancel</button>
            </div>
        `).join('');
    }

    // Tank operation functions
    async function startFill(tankId) {
        const gallons = prompt('Enter gallons to fill:', '50');
        if (!gallons || isNaN(gallons)) return;

        try {
            showLoading('Starting fill...');
            const result = await apiCall(`/api/tank/${tankId}/fill`, {
                method: 'POST',
                body: JSON.stringify({ gallons: parseFloat(gallons) })
            });
            
            showMessage(result.message, 'success');
            updateStatus(); // Immediate update
        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function startMix(tankId) {
        const formula = prompt('Enter formula type (VEG or BLOOM):', 'VEG');
        if (!formula) return;
        
        const gallons = prompt('Enter gallons to mix:', '50');
        if (!gallons || isNaN(gallons)) return;

        try {
            showLoading('Starting mix...');
            const result = await apiCall(`/api/tank/${tankId}/mix`, {
                method: 'POST',
                body: JSON.stringify({ 
                    formula: formula.toUpperCase(),
                    gallons: parseFloat(gallons)
                })
            });
            
            showMessage(result.message, 'success');
            updateStatus(); // Immediate update
        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function startSend(tankId) {
        const gallons = prompt('Enter gallons to send:', '25');
        if (!gallons || isNaN(gallons)) return;

        try {
            showLoading('Starting send...');
            const result = await apiCall(`/api/tank/${tankId}/send`, {
                method: 'POST',
                body: JSON.stringify({ gallons: parseFloat(gallons) })
            });
            
            showMessage(result.message, 'success');
            updateStatus(); // Immediate update
        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function cancelJob(jobId) {
        if (!confirm('Are you sure you want to cancel this job?')) return;

        try {
            showLoading('Cancelling job...');
            const result = await apiCall(`/api/job/${jobId}/cancel`, {
                method: 'POST'
            });
            
            showMessage(result.message, 'success');
            updateStatus(); // Immediate update
        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    async function stopTankOperations(tankId) {
        if (!confirm('Are you sure you want to stop all operations for this tank?')) return;

        try {
            showLoading('Stopping operations...');
            // Cancel all jobs for this tank
            const tank = tanks[tankId];
            if (tank && tank.active_jobs) {
                for (const job of tank.active_jobs) {
                    await apiCall(`/api/job/${job.job_id}/cancel`, { method: 'POST' });
                }
            }
            
            showMessage('Tank operations stopped', 'success');
            updateStatus(); // Immediate update
        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // Quick action functions
    function showQuickFill() {
        showActionModal('Quick Fill', 'fill');
    }

    function showQuickMix() {
        showActionModal('Quick Mix', 'mix');
    }

    function showQuickSend() {
        showActionModal('Quick Send', 'send');
    }

    function showActionModal(title, action) {
        const modal = document.getElementById('action-modal');
        const modalTitle = document.getElementById('modal-title');
        const actionFields = document.getElementById('action-fields');
        const tankSelect = document.getElementById('tank-select');

        modalTitle.textContent = title;

        // Populate tank options
        tankSelect.innerHTML = '<option value="">Select Tank</option>';
        Object.entries(tanks).forEach(([tankId, tank]) => {
            if (tank.available !== false) {
                tankSelect.innerHTML += `<option value="${tankId}">${tank.name}</option>`;
            }
        });

        // Add action-specific fields
        if (action === 'fill') {
            actionFields.innerHTML = `
                <div class="form-group">
                    <label for="fill-gallons">Gallons:</label>
                    <input type="number" id="fill-gallons" class="form-control" min="1" max="100" value="50" required>
                </div>
            `;
        } else if (action === 'mix') {
            actionFields.innerHTML = `
                <div class="form-group">
                    <label for="mix-formula">Formula:</label>
                    <select id="mix-formula" class="form-control" required>
                        <option value="VEG">Vegetative (VEG)</option>
                        <option value="BLOOM">Bloom</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mix-gallons">Gallons:</label>
                    <input type="number" id="mix-gallons" class="form-control" min="1" max="100" value="50" required>
                </div>
            `;
        } else if (action === 'send') {
            actionFields.innerHTML = `
                <div class="form-group">
                    <label for="send-gallons">Gallons:</label>
                    <input type="number" id="send-gallons" class="form-control" min="1" max="100" value="25" required>
                </div>
            `;
        }

        // Set up form submission
        const form = document.getElementById('action-form');
        form.onsubmit = (e) => handleActionSubmit(e, action);

        modal.classList.add('show');
    }

    async function handleActionSubmit(event, action) {
        event.preventDefault();
        
        const tankId = document.getElementById('tank-select').value;
        if (!tankId) {
            showMessage('Please select a tank', 'error');
            return;
        }

        try {
            showLoading(`Starting ${action}...`);
            let result;

            if (action === 'fill') {
                const gallons = document.getElementById('fill-gallons').value;
                result = await apiCall(`/api/tank/${tankId}/fill`, {
                    method: 'POST',
                    body: JSON.stringify({ gallons: parseFloat(gallons) })
                });
            } else if (action === 'mix') {
                const formula = document.getElementById('mix-formula').value;
                const gallons = document.getElementById('mix-gallons').value;
                result = await apiCall(`/api/tank/${tankId}/mix`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        formula: formula,
                        gallons: parseFloat(gallons)
                    })
                });
            } else if (action === 'send') {
                const gallons = document.getElementById('send-gallons').value;
                result = await apiCall(`/api/tank/${tankId}/send`, {
                    method: 'POST',
                    body: JSON.stringify({ gallons: parseFloat(gallons) })
                });
            }

            showMessage(result.message, 'success');
            closeModal();
            updateStatus(); // Immediate update
        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function closeModal() {
        const modal = document.getElementById('action-modal');
        modal.classList.remove('show');
    }

    async function stopAllOperations() {
        if (!confirm('Are you sure you want to stop ALL operations on ALL tanks?')) return;

        try {
            showLoading('Stopping all operations...');
            
            // Cancel all active jobs
            for (const tank of Object.values(tanks)) {
                if (tank.active_jobs) {
                    for (const job of tank.active_jobs) {
                        await apiCall(`/api/job/${job.job_id}/cancel`, { method: 'POST' });
                    }
                }
            }
            
            showMessage('All operations stopped', 'success');
            updateStatus(); // Immediate update
        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('action-modal');
        if (event.target === modal) {
            closeModal();
        }
    }
</script>
{% endblock %}