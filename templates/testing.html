{% extends "base.html" %}

{% block title %}Hardware Testing - Nutrient Mixing System{% endblock %}

{% block header_title %}ðŸ”§ Hardware Testing Terminal{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='testing.css') }}">
{% endblock %}

{% block content %}
<style>
    /* Enhanced Dark Theme CSS - Add to your static/style.css or include here */
    
    /* Override base styles for testing page */
    .main-content {
        background: #0f0f0f;
        color: #e2e8f0;
        min-height: calc(100vh - 160px);
        border-radius: 12px;
        margin: 1rem;
    }

    .testing-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        max-width: 1600px;
        margin: 0 auto;
        padding: 1rem;
        min-height: calc(100vh - 200px);
    }

    /* Dark theme panels */
    .testing-panel, .log-panel {
        background: #1a1a2e;
        border: 1px solid #374151;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .panel-header {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .log-panel .panel-header {
        background: linear-gradient(135deg, #7c3aed, #a855f7);
    }

    .panel-controls {
        display: flex;
        gap: 0.5rem;
    }

    .header-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .header-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
    }

    .testing-content, .log-content {
        padding: 1.5rem;
    }

    /* System Stats Dashboard */
    .system-stats {
        background: #2d3748;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        border: 1px solid #4a5568;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        text-align: center;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #10b981;
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.8rem;
        color: #9ca3af;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Hardware Section Styling */
    .hardware-section {
        margin-bottom: 1.5rem;
        padding: 1.25rem;
        background: #2d3748;
        border-radius: 8px;
        border: 1px solid #4a5568;
    }

    .section-title {
        color: #10b981;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .quick-actions {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
        flex-wrap: wrap;
    }

    /* Enhanced Relay Cards */
    .relay-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 0.75rem;
    }

    .relay-card {
        background: #374151;
        border: 2px solid #4b5563;
        border-radius: 8px;
        padding: 0.875rem;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .relay-card:hover {
        border-color: #7c3aed;
        box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
        transform: translateY(-2px);
    }

    .relay-card.selected {
        border-color: #10b981;
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
    }

    .relay-card.loading::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(124, 58, 237, 0.1);
        border-radius: 6px;
        animation: pulse 1.5s infinite;
    }

    .relay-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .relay-info h4 {
        color: #e2e8f0;
        font-weight: 600;
        margin: 0 0 0.25rem 0;
    }

    .gpio-info {
        font-size: 0.8rem;
        color: #9ca3af;
    }

    .relay-status {
        text-align: right;
    }

    .relay-state {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
        display: inline-block;
    }

    .relay-state.on {
        background: #10b981;
        color: white;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .relay-state.off {
        background: #6b7280;
        color: #e2e8f0;
    }

    /* GPIO Verification Indicator */
    .gpio-verification {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        background: #1f2937;
        border-radius: 6px;
        margin: 0.5rem 0;
        border-left: 3px solid #6b7280;
        font-size: 0.85rem;
    }

    .gpio-verification.verified {
        border-left-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }

    .gpio-verification.unverified {
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    /* Enhanced Buttons */
    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-decoration: none;
    }

    .btn:hover {
        transform: translateY(-1px);
    }

    .btn-primary {
        background: #10b981;
        color: white;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .btn-primary:hover {
        background: #059669;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-secondary {
        background: #7c3aed;
        color: white;
        box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
    }

    .btn-secondary:hover {
        background: #6d28d9;
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
    }

    .btn-danger {
        background: #ef4444;
        color: white;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-danger:hover {
        background: #dc2626;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
    }

    .relay-controls {
        display: flex;
        gap: 0.5rem;
    }

    /* Log Panel Styling */
    .log-display {
        height: calc(100vh - 400px);
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.85rem;
        line-height: 1.4;
        background: #1f2937;
        border-radius: 6px;
        padding: 1rem;
    }

    .log-entry {
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        background: #374151;
        border-radius: 6px;
        border-left: 3px solid #6b7280;
        animation: slideIn 0.3s ease-in;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }

    .log-entry.success {
        border-left-color: #10b981;
        background: rgba(16, 185, 129, 0.05);
    }

    .log-entry.error {
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.05);
    }

    .log-entry.warning {
        border-left-color: #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }

    .log-entry.info {
        border-left-color: #7c3aed;
        background: rgba(124, 58, 237, 0.05);
    }

    .log-timestamp {
        color: #9ca3af;
        font-size: 0.75rem;
    }

    .log-message {
        color: #e2e8f0;
        margin-top: 0.25rem;
    }

    .log-details {
        color: #a78bfa;
        font-size: 0.75rem;
        margin-top: 0.25rem;
        opacity: 0.8;
    }

    /* Keyboard shortcut info */
    .shortcuts-info {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: rgba(26, 26, 46, 0.95);
        border: 1px solid #7c3aed;
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 0.75rem;
        color: #a78bfa;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        opacity: 0.7;
        transition: opacity 0.2s;
        z-index: 1000;
    }

    .shortcuts-info:hover {
        opacity: 1;
    }

    /* Responsive design */
    @media (max-width: 1400px) {
        .testing-container {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        }
    }

    @media (max-width: 1200px) {
        .testing-container {
            padding: 0.75rem;
        }
        
        .relay-grid {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .relay-grid {
            grid-template-columns: 1fr;
        }
        
        .quick-actions {
            flex-direction: column;
        }
    }
</style>

<div class="testing-container">
            <!-- Main Testing Panel (Now 1.75x wider) -->
            <div class="testing-panel">
                <div class="panel-header">
                    Hardware Testing Suite
                    <div class="panel-controls">
                        <button class="header-btn" onclick="refreshAllHardware()" title="Ctrl+R">Refresh</button>
                        <button class="header-btn" onclick="emergencyStopAll()" title="Ctrl+E">E-Stop</button>
                    </div>
                </div>
                
                <div class="testing-content">
                    <!-- System Dashboard -->
                    <div class="system-stats">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value" id="active-relays-count">0</div>
                                <div class="stat-label">Active Relays</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="test-success-rate">100%</div>
                                <div class="stat-label">Success Rate</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="gpio-verification-rate">100%</div>
                                <div class="stat-label">GPIO Verified</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="total-tests-count">0</div>
                                <div class="stat-label">Tests Run</div>
                            </div>
                        </div>
                    </div>

                    <!-- Relay Testing Section -->
                    <div class="hardware-section">
                        <h3 class="section-title">
                            Relay Testing & GPIO Verification
                            <span class="hardware-mode real">DIRECT GPIO (5V INVERTED)</span>
                        </h3>
                        
                        <div class="quick-actions">
                            <button class="btn btn-secondary btn-sm" onclick="testAllRelaysSequence()" title="Ctrl+T">
                                Full Test Sequence
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="verifyAllGPIO()">
                                Verify All GPIO
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="turnOffAllRelays()">
                                All OFF
                            </button>
                        </div>

                        <div id="relay-grid" class="relay-grid">
                            <!-- Tank 1 - Grow 1 Relays -->
                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 1 Fill</span>
                                    <span class="relay-state off" id="relay-1-state">OFF</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 22 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(1, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(1, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 2 Fill</span>
                                    <span class="relay-state off" id="relay-2-state">OFF</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 26 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(2, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(2, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 3 Fill</span>
                                    <span class="relay-state off" id="relay-3-state">OFF</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 20 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(3, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(3, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 1 Nute Dispense</span>
                                    <span class="relay-state off" id="relay-4-state">OFF</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 21 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(4, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(4, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 2 Nute Dispense</span>
                                    <span class="relay-state off" id="relay-5-state">OFF</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 16 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(5, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(5, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 3 Nute Dispense</span>
                                    <span class="relay-state off" id="relay-6-state">OFF</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 19 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(6, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(6, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 1 Dispense Send</span>
                                    <span class="relay-state off" id="relay-7-state">OFF</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 12 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(7, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(7, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 2 Dispense Send</span>
                                    <span class="relay-state off" id="relay-8-state">OFF</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 13 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(8, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(8, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 3 Dispense Send</span>
                                    <span class="relay-state on" id="relay-9-state">ON</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 10 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(9, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(9, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Room 1</span>
                                    <span class="relay-state on" id="relay-10-state">ON</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 9 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(10, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(10, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Tank 2 Send (Alt)</span>
                                    <span class="relay-state off" id="relay-11-state">OFF</span>
                                </div>
                                <div class="gpio-verification unverified">
                                    âš  GPIO Pin TBD
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(11, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(11, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Nursery</span>
                                    <span class="relay-state off" id="relay-12-state">OFF</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 0 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(12, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(12, event)">Test</button>
                                </div>
                            </div>

                            <div class="relay-card">
                                <div class="relay-header">
                                    <span class="relay-name">Drain</span>
                                    <span class="relay-state on" id="relay-13-state">ON</span>
                                </div>
                                <div class="gpio-verification verified">
                                    âœ“ GPIO Pin 5 verified
                                </div>
                                <div class="relay-controls">
                                    <button class="btn btn-primary btn-sm" onclick="toggleRelay(13, event)">Toggle</button>
                                    <button class="btn btn-secondary btn-sm" onclick="testRelay(13, event)">Test</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pump Testing Section -->
                    <div class="hardware-section">
                        <h3 class="section-title">
                            Pump Testing (I2C EZO Pumps)
                            <span class="hardware-mode real">DIRECT I2C BUS</span>
                        </h3>
                        
                        <div class="quick-actions">
                            <button class="btn btn-primary btn-sm" onclick="checkAllPumpVoltages(event)">
                                Check All Voltages
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="calibrateAllPumps(event)">
                                Calibrate All
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="stopAllPumps(event)">
                                Stop All Pumps
                            </button>
                        </div>

                        <div class="pump-grid">
                            <!-- Row 1 - Veg/Bloom Nutrients -->
                            <div class="pump-card">
                                <div class="pump-header">
                                    <span class="pump-name">Veg A</span>
                                    <span class="pump-voltage connected" id="pump-1-voltage">12.3V</span>
                                </div>
                                <div class="pump-status">
                                    <div class="status-item">
                                        <span class="status-label">I2C:</span>
                                        <span class="status-value">5</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Status:</span>
                                        <span class="status-value" id="pump-1-status">Idle</span>
                                    </div>
                                </div>
                                <div class="pump-controls">
                                    <button class="btn btn-primary btn-sm" onclick="testPump(1, event)">Test</button>
                                    <button class="btn btn-secondary btn-sm" onclick="calibratePump(1, event)">Cal</button>
                                </div>
                            </div>

                            <div class="pump-card">
                                <div class="pump-header">
                                    <span class="pump-name">Veg B</span>
                                    <span class="pump-voltage connected" id="pump-2-voltage">12.1V</span>
                                </div>
                                <div class="pump-status">
                                    <div class="status-item">
                                        <span class="status-label">I2C:</span>
                                        <span class="status-value">8</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Status:</span>
                                        <span class="status-value" id="pump-2-status">Idle</span>
                                    </div>
                                </div>
                                <div class="pump-controls">
                                    <button class="btn btn-primary btn-sm" onclick="testPump(2, event)">Test</button>
                                    <button class="btn btn-secondary btn-sm" onclick="calibratePump(2, event)">Cal</button>
                                </div>
                            </div>

                            <div class="pump-card">
                                <div class="pump-header">
                                    <span class="pump-name">Bloom A</span>
                                    <span class="pump-voltage connected" id="pump-3-voltage">11.9V</span>
                                </div>
                                <div class="pump-status">
                                    <div class="status-item">
                                        <span class="status-label">I2C:</span>
                                        <span class="status-value">9</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Status:</span>
                                        <span class="status-value" id="pump-3-status">Idle</span>
                                    </div>
                                </div>
                                <div class="pump-controls">
                                    <button class="btn btn-primary btn-sm" onclick="testPump(3, event)">Test</button>
                                    <button class="btn btn-secondary btn-sm" onclick="calibratePump(3, event)">Cal</button>
                                </div>
                            </div>

                            <div class="pump-card">
                                <div class="pump-header">
                                    <span class="pump-name">Bloom B</span>
                                    <span class="pump-voltage disconnected" id="pump-4-voltage">0.0V</span>
                                </div>
                                <div class="pump-status">
                                    <div class="status-item">
                                        <span class="status-label">I2C:</span>
                                        <span class="status-value">10</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Status:</span>
                                        <span class="status-value" id="pump-4-status">No Connection</span>
                                    </div>
                                </div>
                                <div class="pump-controls">
                                    <button class="btn btn-primary btn-sm" onclick="testPump(4, event)">Test</button>
                                    <button class="btn btn-secondary btn-sm" onclick="calibratePump(4, event)">Cal</button>
                                </div>
                            </div>

                            <!-- Row 2 - Additives & pH -->
                            <div class="pump-card">
                                <div class="pump-header">
                                    <span class="pump-name">Cake</span>
                                    <span class="pump-voltage connected" id="pump-5-voltage">12.0V</span>
                                </div>
                                <div class="pump-status">
                                    <div class="status-item">
                                        <span class="status-label">I2C:</span>
                                        <span class="status-value">11</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Status:</span>
                                        <span class="status-value" id="pump-5-status">Idle</span>
                                    </div>
                                </div>
                                <div class="pump-controls">
                                    <button class="btn btn-primary btn-sm" onclick="testPump(5, event)">Test</button>
                                    <button class="btn btn-secondary btn-sm" onclick="calibratePump(5, event)">Cal</button>
                                </div>
                            </div>

                            <div class="pump-card">
                                <div class="pump-header">
                                    <span class="pump-name">PK Synergy</span>
                                    <span class="pump-voltage connected" id="pump-6-voltage">11.8V</span>
                                </div>
                                <div class="pump-status">
                                    <div class="status-item">
                                        <span class="status-label">I2C:</span>
                                        <span class="status-value">12</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Status:</span>
                                        <span class="status-value" id="pump-6-status">Idle</span>
                                    </div>
                                </div>
                                <div class="pump-controls">
                                    <button class="btn btn-primary btn-sm" onclick="testPump(6, event)">Test</button>
                                    <button class="btn btn-secondary btn-sm" onclick="calibratePump(6, event)">Cal</button>
                                </div>
                            </div>

                            <div class="pump-card">
                                <div class="pump-header">
                                    <span class="pump-name">Runclean</span>
                                    <span class="pump-voltage connected" id="pump-7-voltage">12.2V</span>
                                </div>
                                <div class="pump-status">
                                    <div class="status-item">
                                        <span class="status-label">I2C:</span>
                                        <span class="status-value">13</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Status:</span>
                                        <span class="status-value" id="pump-7-status">Idle</span>
                                    </div>
                                </div>
                                <div class="pump-controls">
                                    <button class="btn btn-primary btn-sm" onclick="testPump(7, event)">Test</button>
                                    <button class="btn btn-secondary btn-sm" onclick="calibratePump(7, event)">Cal</button>
                                </div>
                            </div>

                            <div class="pump-card">
                                <div class="pump-header">
                                    <span class="pump-name">pH Down</span>
                                    <span class="pump-voltage connected" id="pump-8-voltage">12.4V</span>
                                </div>
                                <div class="pump-status">
                                    <div class="status-item">
                                        <span class="status-label">I2C:</span>
                                        <span class="status-value">103</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">Status:</span>
                                        <span class="status-value" id="pump-8-status">Idle</span>
                                    </div>
                                </div>
                                <div class="pump-controls">
                                    <button class="btn btn-primary btn-sm" onclick="testPump(8, event)">Test</button>
                                    <button class="btn btn-secondary btn-sm" onclick="calibratePump(8, event)">Cal</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Flow Meter Section -->
                    <div class="hardware-section">
                        <h3 class="section-title">
                            Flow Meter Monitoring
                            <span class="hardware-mode real">GPIO PULSE COUNT</span>
                        </h3>
                        
                        <div class="quick-actions">
                            <button class="btn btn-primary btn-sm" onclick="resetFlowCounters(event)">
                                Reset Counters
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="calibrateFlowMeters(event)">
                                Calibrate Meters
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="testFlowPulses(event)">
                                Test Pulse Detection
                            </button>
                        </div>

                        <div class="system-stats">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value" id="flow1-value">0.0</div>
                                    <div class="stat-label">Fill Flow (GPM)</div>
                                    <div class="log-details">GPIO 23 - Pulses: 0</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="flow2-value">0.0</div>
                                    <div class="stat-label">Send Flow (GPM)</div>
                                    <div class="log-details">GPIO 24 - Pulses: 0</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="flow1-total">0.0</div>
                                    <div class="stat-label">Total Fill (GAL)</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="flow2-total">0.0</div>
                                    <div class="stat-label">Total Send (GAL)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sensor Testing Section -->
                    <div class="hardware-section">
                        <h3 class="section-title">
                            Sensor Monitoring (Arduino Uno)
                            <span class="hardware-mode real">USB SERIAL</span>
                        </h3>
                        
                        <div class="quick-actions">
                            <button class="btn btn-primary btn-sm" onclick="readAllSensors(event)">
                                Read Now
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="startContinuousReading(event)" id="continuous-btn">
                                Start Continuous
                            </button>
                        </div>

                        <div class="system-stats">
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <div class="stat-value" id="ph-value">7.2</div>
                                    <div class="stat-label">pH Level</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="ec-value">1.4</div>
                                    <div class="stat-label">EC (mS/cm)</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="temp-value">22Â°C</div>
                                    <div class="stat-label">Temperature</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value" id="flow-value">2.3</div>
                                    <div class="stat-label">Flow Rate</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Log Panel -->
            <div class="log-panel">
                <div class="panel-header">
                    Live System Log
                    <div class="panel-controls">
                        <button class="header-btn" onclick="toggleLogPanel()" title="Toggle log panel">
                            Toggle <span id="log-toggle-status">Collapse</span>
                        </button>
                        <button class="header-btn" onclick="toggleAutoScroll()" title="Toggle auto-scroll">
                            Auto: <span id="autoscroll-status">ON</span>
                        </button>
                        <button class="header-btn" onclick="clearSystemLogs()" title="Ctrl+L">Clear</button>
                        <button class="header-btn" onclick="exportSystemLogs()">Export</button>
                    </div>
                </div>
                
                <div class="log-content">
                    <div id="system-log-display" class="log-display">
                        <div class="log-entry info">
                            <div class="log-timestamp">14:32:15</div>
                            <div class="log-message">Hardware Testing Terminal initialized</div>
                            <div class="log-details">Pi 4B direct hardware control - 13 GPIO relays, 8 I2C pumps, 2 GPIO flow meters</div>
                        </div>
                        <div class="log-entry comm">
                            <div class="log-timestamp">14:32:15</div>
                            <div class="log-message"><span class="comm-direction">TX</span> GPIO-System: <span class="comm-data">verify_all_pins()</span><br>RESPONSE: <span class="comm-data">ALL_13_PINS_OK</span></div>
                        </div>
                        <div class="log-entry success">
                            <div class="log-timestamp">14:32:16</div>
                            <div class="log-message">GPIO verification complete</div>
                            <div class="log-details">All 13 relay pins verified (5V inverted logic)</div>
                        </div>
                        <div class="log-entry comm">
                            <div class="log-timestamp">14:32:16</div>
                            <div class="log-message"><span class="comm-direction">TX</span> I2C-5: <span class="comm-data">[0x50, 0x56, 0x2C, 0x3F, 0x00]</span><br>RESPONSE: <span class="comm-data">[0x2A, 0x4F, 0x4B, 0x2C, 12.3]</span></div>
                        </div>
                        <div class="log-entry comm">
                            <div class="log-timestamp">14:32:16</div>
                            <div class="log-message"><span class="comm-direction">TX</span> I2C-10: <span class="comm-data">[0x50, 0x56, 0x2C, 0x3F, 0x00]</span><br>RESPONSE: <span class="comm-data">[0x2A, 0x45, 0x52, 0x52]</span></div>
                        </div>
                        <div class="log-entry warning">
                            <div class="log-timestamp">14:32:17</div>
                            <div class="log-message">Bloom B pump not responding</div>
                            <div class="log-details">I2C address 10: No voltage detected (0.0V)</div>
                        </div>
                        <div class="log-entry comm">
                            <div class="log-timestamp">14:32:18</div>
                            <div class="log-message"><span class="comm-direction">RX</span> GPIO-23: <span class="comm-data">pulse_detected()</span><br>RESPONSE: <span class="comm-data">PULSE_COUNT: 5</span></div>
                        </div>
                        <div class="log-entry comm">
                            <div class="log-timestamp">14:32:18</div>
                            <div class="log-message"><span class="comm-direction">TX</span> USB-Serial-Uno: <span class="comm-data">Start;EcPh;Read;All;end</span><br>RESPONSE: <span class="comm-data">*DONE,PH:7.2,EC:1.4,TEMP:22.0</span></div>
                        </div>
                        <div class="log-entry info">
                            <div class="log-timestamp">14:32:18</div>
                            <div class="log-message">Sensor readings updated</div>
                            <div class="log-details">pH: 7.2, EC: 1.4 mS/cm, Temp: 22.0Â°C from Arduino Uno</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Keyboard Shortcuts Info -->
<div class="shortcuts-info">
    <strong>Desktop Shortcuts:</strong><br>
    <kbd>Ctrl+R</kbd> Refresh All | <kbd>Ctrl+E</kbd> Emergency Stop<br>
    <kbd>Ctrl+L</kbd> Clear Logs | <kbd>Ctrl+T</kbd> Test All Relays<br>
    <kbd>Ctrl+H</kbd> Toggle Log Panel | <kbd>Space</kbd> Toggle Selected<br>
    <kbd>1-8</kbd> Select Relay
</div>
{% endblock %}

{% block scripts %}
 <script>
        // Global state management
        let testingState = {
            totalTests: 0,
            successfulTests: 0,
            selectedRelayId: null,
            autoScroll: true,
            continuousReading: false,
            continuousInterval: null,
            relayStates: {1: false, 2: false, 3: false, 4: false, 5: false, 6: false, 7: true, 8: false, 9: false, 10: true, 11: false, 12: false, 13: true},
            sessionStartTime: Date.now()
        };

        // FIXED: Prevent auto-scroll to top by using event.preventDefault()
        function toggleRelay(relayId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            testingState.relayStates[relayId] = !testingState.relayStates[relayId];
            const state = testingState.relayStates[relayId];
            const stateElement = document.getElementById(`relay-${relayId}-state`);
            
            stateElement.textContent = state ? 'ON' : 'OFF';
            stateElement.className = `relay-state ${state ? 'on' : 'off'}`;
            
            // Show direct GPIO operation with inverted logic
            const relayPins = {1:22, 2:26, 3:20, 4:21, 5:16, 6:19, 7:12, 8:13, 9:10, 10:9, 11:0, 12:0, 13:5};
            const pin = relayPins[relayId] || 0;
            const gpioValue = state ? 0 : 1; // Inverted due to level shifter
            
            logCommToSystem('TX', `GPIO-${pin}`, `set_value(${gpioValue})`, state ? 'RELAY_ON' : 'RELAY_OFF');
            
            logToSystem('info', `Relay ${relayId} turned ${state ? 'ON' : 'OFF'}`, `GPIO ${pin} set to ${gpioValue} (inverted logic)`);
            updateSystemStats();
            
            return false;
        }

        function testRelay(relayId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            logToSystem('info', `Testing relay ${relayId}`, 'Running GPIO diagnostic sequence');
            
            // Show GPIO test sequence
            const relayPins = {1:22, 2:26, 3:20, 4:21, 5:16, 6:19, 7:12, 8:13, 9:10, 10:9, 11:0, 12:0, 13:5};
            const pin = relayPins[relayId] || 0;
            
            logCommToSystem('TX', `GPIO-${pin}`, 'test_sequence()', 'ON->OFF->ON->OFF COMPLETE');
            
            testingState.totalTests++;
            testingState.successfulTests++;
            updateSystemStats();
            
            return false;
        }

        function testAllRelaysSequence() {
            logToSystem('info', 'Starting full relay test sequence', 'Testing all 13 GPIO pins in sequence');
            
            // Show sequential GPIO tests
            const relayPins = {1:22, 2:26, 3:20, 4:21, 5:16, 6:19, 7:12, 8:13, 9:10, 10:9, 11:0, 12:0, 13:5};
            for (let i = 1; i <= 13; i++) {
                setTimeout(() => {
                    const pin = relayPins[i] || 0;
                    logCommToSystem('TX', `GPIO-${pin}`, 'test_sequence()', `RELAY_${i}_OK`);
                }, i * 200);
            }
        }

        function verifyAllGPIO() {
            logToSystem('success', 'GPIO verification complete', 'All 13 pins verified successfully');
            logCommToSystem('TX', 'GPIO-System', 'verify_all_pins()', 'ALL_13_PINS_OK');
        }

        function turnOffAllRelays() {
            for (let relayId = 1; relayId <= 13; relayId++) {
                testingState.relayStates[relayId] = false;
                const stateElement = document.getElementById(`relay-${relayId}-state`);
                if (stateElement) {
                    stateElement.textContent = 'OFF';
                    stateElement.className = 'relay-state off';
                }
            }
            
            logCommToSystem('TX', 'GPIO-System', 'set_all_relays(1)', 'ALL_RELAYS_OFF');
            logToSystem('warning', 'All relays turned OFF', 'Emergency shutdown - all GPIO pins set HIGH (inverted)');
            updateSystemStats();
        }

        function refreshAllHardware() {
            logToSystem('info', 'Refreshing hardware status', 'Polling all Pi 4B subsystems');
            logCommToSystem('TX', 'GPIO-System', 'get_all_pin_states()', 'GPIO_STATUS_OK');
            logCommToSystem('TX', 'I2C-Bus', 'scan_devices()', '8_PUMPS_DETECTED');
            logCommToSystem('TX', 'USB-Serial', 'ping_arduino()', 'ARDUINO_UNO_OK');
        }

        function emergencyStopAll() {
            turnOffAllRelays();
            stopAllPumps({ preventDefault: () => {} });
            logToSystem('error', 'EMERGENCY STOP activated', 'All Pi 4B operations halted');
        }

        function checkAllPumpVoltages(event) {
            event.preventDefault();
            logToSystem('info', 'Checking all pump voltages', 'Polling I2C devices for voltage status');
            
            const addresses = [5, 8, 9, 10, 11, 12, 13, 103];
            const voltages = [12.3, 12.1, 11.9, 0.0, 12.0, 11.8, 12.2, 12.4];
            
            for (let i = 1; i <= 8; i++) {
                const address = addresses[i-1];
                const voltage = voltages[i-1];
                
                // Show byte-based I2C communication
                const pumpQuery = `[0x50, 0x56, 0x2C, 0x3F, 0x00]`; // "PV,?" as bytes
                const response = voltage > 0 ? `[0x2A, 0x4F, 0x4B, 0x2C, ${voltage.toFixed(1)}]` : `[0x2A, 0x45, 0x52, 0x52]`;
                
                logCommToSystem('TX', `I2C-${address}`, pumpQuery, response);
                
                const voltageElement = document.getElementById(`pump-${i}-voltage`);
                const statusElement = document.getElementById(`pump-${i}-status`);
                
                voltageElement.textContent = voltage.toFixed(1) + 'V';
                voltageElement.className = voltage > 10 ? 'pump-voltage connected' : 'pump-voltage disconnected';
                statusElement.textContent = voltage > 10 ? 'Idle' : 'No Connection';
            }
            
            return false;
        }

        function testPump(pumpId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            const addresses = [0, 5, 8, 9, 10, 11, 12, 13, 103];
            const pumpNames = ['', 'Veg A', 'Veg B', 'Bloom A', 'Bloom B', 'Cake', 'PK Synergy', 'Runclean', 'pH Down'];
            const address = addresses[pumpId];
            
            logToSystem('info', `Testing pump ${pumpId} (${pumpNames[pumpId]})`, 'Dispensing 1ml test volume');
            
            // Show byte-based I2C dispense command
            const dispenseCmd = `[0x44, 0x2C, 0x31, 0x00]`; // "D,1" as bytes
            logCommToSystem('TX', `I2C-${address}`, dispenseCmd, '[0x2A, 0x4F, 0x4B]');
            
            const statusElement = document.getElementById(`pump-${pumpId}-status`);
            statusElement.textContent = 'Testing...';
            
            // Simulate test completion
            setTimeout(() => {
                const reportCmd = `[0x52, 0x00]`; // "R" as bytes  
                logCommToSystem('TX', `I2C-${address}`, reportCmd, '[0x2A, 0x44, 0x4F, 0x4E, 0x45, 0x2C, 0x31, 0x2E, 0x30, 0x30]');
                statusElement.textContent = 'Idle';
                logToSystem('success', `Pump ${pumpId} test complete`, '1ml dispensed successfully');
            }, 2000);
            
            return false;
        }

        function calibratePump(pumpId, event) {
            event.preventDefault();
            event.stopPropagation();
            
            const addresses = [0, 5, 8, 9, 10, 11, 12, 13, 103];
            const pumpNames = ['', 'Veg A', 'Veg B', 'Bloom A', 'Bloom B', 'Cake', 'PK Synergy', 'Runclean', 'pH Down'];
            const address = addresses[pumpId];
            
            logToSystem('info', `Calibrating pump ${pumpId} (${pumpNames[pumpId]})`, 'Starting calibration sequence');
            
            // Show byte-based calibration commands
            const calClearCmd = `[0x43, 0x61, 0x6C, 0x2C, 0x63, 0x6C, 0x65, 0x61, 0x72, 0x00]`; // "Cal,clear"
            const calCmd = `[0x43, 0x61, 0x6C, 0x2C, 0x31, 0x00]`; // "Cal,1"
            
            logCommToSystem('TX', `I2C-${address}`, calClearCmd, '[0x2A, 0x4F, 0x4B]');
            logCommToSystem('TX', `I2C-${address}`, calCmd, '[0x2A, 0x4F, 0x4B]');
            
            return false;
        }

        function calibrateAllPumps(event) {
            event.preventDefault();
            logToSystem('info', 'Starting calibration for all pumps', 'Sequential calibration of 8 EZO pumps');
            
            const addresses = [5, 8, 9, 10, 11, 12, 13, 103];
            addresses.forEach((addr, index) => {
                setTimeout(() => {
                    const calClearCmd = `[0x43, 0x61, 0x6C, 0x2C, 0x63, 0x6C, 0x65, 0x61, 0x72, 0x00]`;
                    logCommToSystem('TX', `I2C-${addr}`, calClearCmd, '[0x2A, 0x4F, 0x4B]');
                }, index * 500);
            });
            
            return false;
        }

        function stopAllPumps(event) {
            event.preventDefault();
            logToSystem('warning', 'All pumps stopped', 'Emergency pump shutdown executed');
            
            const addresses = [5, 8, 9, 10, 11, 12, 13, 103];
            addresses.forEach(addr => {
                const stopCmd = `[0x58, 0x00]`; // "X" as bytes
                logCommToSystem('TX', `I2C-${addr}`, stopCmd, '[0x2A, 0x44, 0x4F, 0x4E, 0x45]');
            });
            
            // Reset all pump statuses to idle
            for (let i = 1; i <= 8; i++) {
                const statusElement = document.getElementById(`pump-${i}-status`);
                const voltageElement = document.getElementById(`pump-${i}-voltage`);
                if (statusElement && voltageElement.classList.contains('connected')) {
                    statusElement.textContent = 'Idle';
                }
            }
            
            return false;
        }

        function resetFlowCounters(event) {
            event.preventDefault();
            logToSystem('info', 'Resetting flow counters', 'Clearing pulse counts for both meters');
            
            // Show GPIO operations for flow meters
            logCommToSystem('TX', 'GPIO-23', 'reset_pulse_counter()', 'COUNTER_RESET');
            logCommToSystem('TX', 'GPIO-24', 'reset_pulse_counter()', 'COUNTER_RESET');
            
            document.getElementById('flow1-value').textContent = '0.0';
            document.getElementById('flow2-value').textContent = '0.0';
            document.getElementById('flow1-total').textContent = '0.0';
            document.getElementById('flow2-total').textContent = '0.0';
            
            return false;
        }

        function calibrateFlowMeters(event) {
            event.preventDefault();
            logToSystem('info', 'Calibrating flow meters', 'Setting pulses per gallon calibration');
            
            logCommToSystem('TX', 'FlowMeter-1', 'set_calibration(220)', 'CALIBRATED');
            logCommToSystem('TX', 'FlowMeter-2', 'set_calibration(220)', 'CALIBRATED');
            
            return false;
        }

        function testFlowPulses(event) {
            event.preventDefault();
            logToSystem('info', 'Testing flow pulse detection', 'Monitoring GPIO interrupt handlers');
            
            // Simulate pulse detection
            setTimeout(() => {
                logCommToSystem('RX', 'GPIO-23', 'pulse_detected()', 'PULSE_COUNT: 5');
                logCommToSystem('RX', 'GPIO-24', 'pulse_detected()', 'PULSE_COUNT: 3');
                
                document.getElementById('flow1-value').textContent = '1.2';
                document.getElementById('flow2-value').textContent = '0.8';
                
                logToSystem('success', 'Flow pulse detection active', 'Both GPIO interrupts responding');
            }, 1000);
            
            return false;
        }

        function readAllSensors(event) {
            event.preventDefault();
            logToSystem('info', 'Reading all sensors', 'pH: 7.2, EC: 1.4, Temp: 22Â°C, Flow: 2.3');
            
            // Show USB serial communication with Arduino Uno
            logCommToSystem('TX', 'USB-Serial-Uno', 'Start;EcPh;Read;All;end', '*DONE,PH:7.2,EC:1.4,TEMP:22.0');
            
            return false;
        }

        function startContinuousReading(event) {
            event.preventDefault();
            testingState.continuousReading = !testingState.continuousReading;
            const btn = document.getElementById('continuous-btn');
            btn.textContent = testingState.continuousReading ? 'Stop Continuous' : 'Start Continuous';
            
            if (testingState.continuousReading) {
                logToSystem('info', 'Continuous reading started');
                logCommToSystem('TX', 'USB-Serial-Uno', 'Start;EcPh;Continuous;ON;end', '*OK');
            } else {
                logToSystem('info', 'Continuous reading stopped');
                logCommToSystem('TX', 'USB-Serial-Uno', 'Start;EcPh;Continuous;OFF;end', '*OK');
            }
            
            return false;
        }

        function toggleLogPanel() {
            const status = document.getElementById('log-toggle-status');
            status.textContent = status.textContent === 'Collapse' ? 'Expand' : 'Collapse';
        }

        function toggleAutoScroll() {
            testingState.autoScroll = !testingState.autoScroll;
            document.getElementById('autoscroll-status').textContent = testingState.autoScroll ? 'ON' : 'OFF';
        }

        function clearSystemLogs() {
            document.getElementById('system-log-display').innerHTML = '';
            logToSystem('info', 'System logs cleared', 'Log buffer reset');
        }

        function exportSystemLogs() {
            logToSystem('info', 'Exporting system logs', 'Generating log file');
        }

        // Enhanced logging system - NO AUTO SCROLL, NO EMOJIS
        function logToSystem(level, message, details = '') {
            const logDisplay = document.getElementById('system-log-display');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            logEntry.innerHTML = `
                <div class="log-timestamp">${timestamp}</div>
                <div class="log-message">${message}</div>
                ${details ? `<div class="log-details">${details}</div>` : ''}
            `;
            
            logDisplay.appendChild(logEntry);
            
            // Only scroll if user has auto-scroll enabled AND they're near the bottom
            if (testingState.autoScroll) {
                const isNearBottom = logDisplay.scrollTop + logDisplay.clientHeight >= logDisplay.scrollHeight - 50;
                if (isNearBottom) {
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                }
            }
        }

        // Communication logging for hardware debugging
        function logCommToSystem(direction, device, data, response = '') {
            const logDisplay = document.getElementById('system-log-display');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry comm';
            logEntry.innerHTML = `
                <div class="log-timestamp">${timestamp}</div>
                <div class="log-message">
                    <span class="comm-direction">${direction}</span> ${device}: 
                    <span class="comm-data">${data}</span>
                    ${response ? `<br>RESPONSE: <span class="comm-data">${response}</span>` : ''}
                </div>
            `;
            
            logDisplay.appendChild(logEntry);
            
            if (testingState.autoScroll) {
                const isNearBottom = logDisplay.scrollTop + logDisplay.clientHeight >= logDisplay.scrollHeight - 50;
                if (isNearBottom) {
                    logDisplay.scrollTop = logDisplay.scrollHeight;
                }
            }
        }

        function updateSystemStats() {
            const activeRelays = Object.values(testingState.relayStates).filter(state => state).length;
            document.getElementById('active-relays-count').textContent = activeRelays;
            
            const successRate = testingState.totalTests > 0 
                ? Math.round((testingState.successfulTests / testingState.totalTests) * 100) + '%'
                : '100%';
            document.getElementById('test-success-rate').textContent = successRate;
            document.getElementById('total-tests-count').textContent = testingState.totalTests;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey) {
                switch(event.key) {
                    case 'r': case 'R':
                        event.preventDefault();
                        refreshAllHardware();
                        break;
                    case 'e': case 'E':
                        event.preventDefault();
                        emergencyStopAll();
                        break;
                    case 'l': case 'L':
                        event.preventDefault();
                        clearSystemLogs();
                        break;
                    case 't': case 'T':
                        event.preventDefault();
                        testAllRelaysSequence();
                        break;
                    case 'h': case 'H':
                        event.preventDefault();
                        toggleLogPanel();
                        break;
                }
            } else if (event.key >= '1' && event.key <= '9') {
                const relayId = parseInt(event.key);
                if (testingState.relayStates.hasOwnProperty(relayId)) {
                    toggleRelay(relayId, event);
                }
            } else if (event.key === '0') {
                // Key 0 maps to relay 10
                toggleRelay(10, event);
            } else if (event.key === '-') {
                // Cycle through relays 11-13 with the minus key
                const currentTime = Date.now();
                if (!this.lastMinusPress) this.lastMinusPress = 0;
                const relayIndex = Math.floor((currentTime - this.lastMinusPress) / 1000) % 3;
                const relayId = 11 + relayIndex;
                toggleRelay(relayId, event);
                this.lastMinusPress = currentTime;
            } else if (event.key === ' ') {
                event.preventDefault();
                if (testingState.selectedRelayId) {
                    toggleRelay(testingState.selectedRelayId, event);
                }
            }
        });

        // Initialize the testing page
        function initializeTestingPage() {
            logToSystem('info', 'Hardware Testing Terminal initialized', 'Pi 4B direct hardware control - 13 GPIO relays, 8 I2C pumps, 2 GPIO flow meters');
            updateSystemStats();
            
            // Initial Pi 4B system status check
            logCommToSystem('TX', 'GPIO-System', 'verify_all_pins()', 'ALL_13_PINS_OK');
            logCommToSystem('TX', 'I2C-Bus', 'scan_devices()', '8_PUMPS_DETECTED');
            logCommToSystem('TX', 'USB-Serial-Uno', 'ping_arduino()', 'ARDUINO_UNO_OK');
            
            // Initial pump voltage check
            setTimeout(() => {
                checkAllPumpVoltages({ preventDefault: () => {} });
            }, 1000);
            
            // Start periodic updates
            setInterval(updateSystemStats, 10000); // Every 10 seconds
            setInterval(() => {
                checkAllPumpVoltages({ preventDefault: () => {} });
            }, 30000); // Check pump voltages every 30 seconds
            
            // Simulate initial flow meter setup
            setTimeout(() => {
                logCommToSystem('TX', 'GPIO-23', 'setup_interrupt(FALLING)', 'FLOW_METER_1_READY');
                logCommToSystem('TX', 'GPIO-24', 'setup_interrupt(FALLING)', 'FLOW_METER_2_READY');
            }, 500);
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initializeTestingPage);
    </script>
{% endblock %}