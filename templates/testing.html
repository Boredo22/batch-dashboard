{% extends "base.html" %}

{% block title %}Testing - Nutrient Mixing System{% endblock %}

{% block header_title %}Hardware Testing{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Hardware Testing -->
    <section class="testing-section">
        <h2 class="section-title">Hardware Component Testing</h2>
        
        <!-- Relay Testing -->
        <div class="test-card">
            <h3 class="test-title">Relay Testing</h3>
            <div class="test-content">
                <div id="relay-grid" class="relay-grid">
                    <div class="loading-placeholder">Loading relays...</div>
                </div>
                <div class="test-actions">
                    <button class="btn btn-warning" onclick="testAllRelays()">Test All Relays</button>
                    <button class="btn btn-danger" onclick="turnOffAllRelays()">Turn Off All</button>
                </div>
            </div>
        </div>

        <!-- Pump Testing -->
        <div class="test-card">
            <h3 class="test-title">Pump Testing</h3>
            <div class="test-content">
                <div id="pump-grid" class="pump-grid">
                    <div class="loading-placeholder">Loading pumps...</div>
                </div>
                <div class="test-actions">
                    <button class="btn btn-info" onclick="showPumpTestModal()">Custom Test</button>
                    <button class="btn btn-warning" onclick="stopAllPumps()">Stop All Pumps</button>
                </div>
            </div>
        </div>

        <!-- Flow Meter Testing -->
        <div class="test-card">
            <h3 class="test-title">Flow Meter Testing</h3>
            <div class="test-content">
                <div id="flow-grid" class="flow-grid">
                    <div class="loading-placeholder">Loading flow meters...</div>
                </div>
                <div class="test-actions">
                    <button class="btn btn-info" onclick="showFlowTestModal()">Test Flow</button>
                    <button class="btn btn-warning" onclick="stopAllFlow()">Stop All Flow</button>
                </div>
            </div>
        </div>

        <!-- Sensor Testing -->
        <div class="test-card">
            <h3 class="test-title">pH/EC Sensor Testing</h3>
            <div class="test-content">
                <div id="sensor-readings" class="sensor-readings">
                    <div class="loading-placeholder">Loading sensors...</div>
                </div>
                <div class="test-actions">
                    <button class="btn btn-primary" onclick="readSensors()">Read Sensors</button>
                    <button class="btn btn-info" onclick="calibrateSensors()">Calibrate</button>
                    <button class="btn btn-success" onclick="startContinuousReading()">Continuous</button>
                    <button class="btn btn-secondary" onclick="stopContinuousReading()">Stop</button>
                </div>
            </div>
        </div>
    </section>

    <!-- System Diagnostics -->
    <section class="diagnostics-section">
        <h2 class="section-title">System Diagnostics</h2>
        
        <div class="diagnostics-grid">
            <!-- Hardware Logs -->
            <div class="diagnostic-card">
                <h3 class="card-title">Hardware Logs</h3>
                <div id="hardware-logs" class="log-display">
                    <div class="loading-placeholder">Loading logs...</div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-info" onclick="refreshHardwareLogs()">Refresh</button>
                    <button class="btn btn-secondary" onclick="clearLogs()">Clear</button>
                </div>
            </div>

            <!-- Job History -->
            <div class="diagnostic-card">
                <h3 class="card-title">Job History</h3>
                <div id="job-logs" class="log-display">
                    <div class="loading-placeholder">Loading jobs...</div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-info" onclick="refreshJobLogs()">Refresh</button>
                    <button class="btn btn-secondary" onclick="exportLogs()">Export</button>
                </div>
            </div>

            <!-- System Health -->
            <div class="diagnostic-card">
                <h3 class="card-title">System Health</h3>
                <div id="system-health" class="health-display">
                    <div class="health-metric">
                        <span class="metric-label">CPU Usage:</span>
                        <span class="metric-value" id="cpu-usage">--</span>
                    </div>
                    <div class="health-metric">
                        <span class="metric-label">Memory Usage:</span>
                        <span class="metric-value" id="memory-usage">--</span>
                    </div>
                    <div class="health-metric">
                        <span class="metric-label">Disk Space:</span>
                        <span class="metric-value" id="disk-usage">--</span>
                    </div>
                    <div class="health-metric">
                        <span class="metric-label">Temperature:</span>
                        <span class="metric-value" id="system-temp">--</span>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-info" onclick="refreshSystemHealth()">Refresh</button>
                    <button class="btn btn-warning" onclick="runDiagnostics()">Full Diagnostic</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Manual Controls -->
    <section class="manual-section">
        <h2 class="section-title">Manual Controls</h2>
        <div class="manual-grid">
            <div class="manual-card">
                <h3 class="card-title">Emergency Controls</h3>
                <div class="emergency-controls">
                    <button class="btn btn-danger btn-large" onclick="emergencyStop()">
                        ðŸš¨ EMERGENCY STOP ðŸš¨
                    </button>
                    <button class="btn btn-warning" onclick="resetSystem()">Reset System</button>
                    <button class="btn btn-info" onclick="restartServices()">Restart Services</button>
                </div>
            </div>
            
            <div class="manual-card">
                <h3 class="card-title">Mock Hardware</h3>
                <div class="mock-controls">
                    <div class="mock-toggle">
                        <label for="mock-relays">Mock Relays:</label>
                        <input type="checkbox" id="mock-relays" onchange="toggleMockHardware('relays')">
                    </div>
                    <div class="mock-toggle">
                        <label for="mock-pumps">Mock Pumps:</label>
                        <input type="checkbox" id="mock-pumps" onchange="toggleMockHardware('pumps')">
                    </div>
                    <div class="mock-toggle">
                        <label for="mock-flow">Mock Flow:</label>
                        <input type="checkbox" id="mock-flow" onchange="toggleMockHardware('flow')">
                    </div>
                    <div class="mock-toggle">
                        <label for="mock-sensors">Mock Sensors:</label>
                        <input type="checkbox" id="mock-sensors" onchange="toggleMockHardware('sensors')">
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Pump Test Modal -->
<div id="pump-test-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Pump Test</h3>
            <button class="modal-close" onclick="closePumpTestModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="pump-test-form">
                <div class="form-group">
                    <label for="test-pump-select">Pump:</label>
                    <select id="test-pump-select" class="form-control" required>
                        <option value="">Select Pump</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="test-amount">Amount (ml):</label>
                    <input type="number" id="test-amount" class="form-control" min="0.5" max="50" value="5" step="0.5" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePumpTestModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Start Test</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Flow Test Modal -->
<div id="flow-test-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Flow Meter Test</h3>
            <button class="modal-close" onclick="closeFlowTestModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="flow-test-form">
                <div class="form-group">
                    <label for="test-flow-select">Flow Meter:</label>
                    <select id="test-flow-select" class="form-control" required>
                        <option value="">Select Flow Meter</option>
                        <option value="1">Tank Fill</option>
                        <option value="2">Tank Send</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="test-gallons">Target Gallons:</label>
                    <input type="number" id="test-gallons" class="form-control" min="0.1" max="10" value="1" step="0.1" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeFlowTestModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Start Test</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Page-specific variables
    let hardwareStatus = {};
    let continuousReadingInterval = null;

    // Initialize page
    function initializePage() {
        loadHardwareStatus();
        loadLogs();
    }

    // Update page with status
    function updatePageStatus(status) {
        hardwareStatus = status.hardware_status || {};
        updateHardwareDisplays();
    }

    // Load hardware status
    async function loadHardwareStatus() {
        try {
            const response = await apiCall('/api/settings/hardware');
            updateRelayGrid(response.hardware_status?.relays || {});
            updatePumpGrid(response.hardware_status?.pumps || {});
            updateFlowGrid(response.hardware_status?.flow_meters || {});
        } catch (error) {
            showMessage('Failed to load hardware status: ' + error.message, 'error');
        }
    }

    // Update hardware displays
    function updateHardwareDisplays() {
        if (hardwareStatus.relays) updateRelayGrid(hardwareStatus.relays);
        if (hardwareStatus.pumps) updatePumpGrid(hardwareStatus.pumps);
        if (hardwareStatus.flow_meters) updateFlowGrid(hardwareStatus.flow_meters);
    }

    // Update relay grid
    function updateRelayGrid(relays) {
        const container = document.getElementById('relay-grid');
        if (!container) return;

        if (Object.keys(relays).length === 0) {
            container.innerHTML = '<div class="no-hardware">No relays available</div>';
            return;
        }

        container.innerHTML = Object.entries(relays).map(([relayId, state]) => `
            <div class="relay-item">
                <div class="relay-info">
                    <span class="relay-name">Relay ${relayId}</span>
                    <span class="relay-state ${state ? 'on' : 'off'}">${state ? 'ON' : 'OFF'}</span>
                </div>
                <div class="relay-controls">
                    <button class="btn btn-sm btn-success" onclick="testRelay(${relayId}, 'on')">ON</button>
                    <button class="btn btn-sm btn-danger" onclick="testRelay(${relayId}, 'off')">OFF</button>
                    <button class="btn btn-sm btn-info" onclick="testRelay(${relayId}, 'toggle')">Toggle</button>
                </div>
            </div>
        `).join('');
    }

    // Update pump grid
    function updatePumpGrid(pumps) {
        const container = document.getElementById('pump-grid');
        if (!container) return;

        if (Object.keys(pumps).length === 0) {
            container.innerHTML = '<div class="no-hardware">No pumps available</div>';
            return;
        }

        container.innerHTML = Object.entries(pumps).map(([pumpId, pump]) => `
            <div class="pump-item">
                <div class="pump-info">
                    <span class="pump-name">${pump.name || `Pump ${pumpId}`}</span>
                    <span class="pump-status ${pump.connected ? 'connected' : 'disconnected'}">
                        ${pump.connected ? 'Connected' : 'Disconnected'}
                    </span>
                </div>
                <div class="pump-details">
                    <div class="pump-detail">
                        <span>Dispensing:</span>
                        <span class="${pump.is_dispensing ? 'active' : 'inactive'}">
                            ${pump.is_dispensing ? 'Yes' : 'No'}
                        </span>
                    </div>
                    <div class="pump-detail">
                        <span>Voltage:</span>
                        <span>${pump.voltage?.toFixed(1) || '--'}V</span>
                    </div>
                </div>
                <div class="pump-controls">
                    <button class="btn btn-sm btn-primary" onclick="testPump(${pumpId}, 5)">Test 5ml</button>
                    <button class="btn btn-sm btn-warning" onclick="stopPump(${pumpId})">Stop</button>
                </div>
            </div>
        `).join('');
    }

    // Update flow grid
    function updateFlowGrid(flowMeters) {
        const container = document.getElementById('flow-grid');
        if (!container) return;

        if (Object.keys(flowMeters).length === 0) {
            container.innerHTML = '<div class="no-hardware">No flow meters available</div>';
            return;
        }

        container.innerHTML = Object.entries(flowMeters).map(([meterId, meter]) => `
            <div class="flow-item">
                <div class="flow-info">
                    <span class="flow-name">${meter.name || `Flow ${meterId}`}</span>
                    <span class="flow-status ${meter.status === 1 ? 'active' : 'inactive'}">
                        ${meter.status === 1 ? 'Active' : 'Inactive'}
                    </span>
                </div>
                <div class="flow-details">
                    <div class="flow-detail">
                        <span>Current:</span>
                        <span>${meter.current_gallons || 0} gal</span>
                    </div>
                    <div class="flow-detail">
                        <span>Target:</span>
                        <span>${meter.target_gallons || 0} gal</span>
                    </div>
                    <div class="flow-detail">
                        <span>Pulses:</span>
                        <span>${meter.pulse_count || 0}</span>
                    </div>
                </div>
                <div class="flow-controls">
                    <button class="btn btn-sm btn-primary" onclick="testFlow(${meterId}, 1)">Test 1 gal</button>
                    <button class="btn btn-sm btn-warning" onclick="stopFlow(${meterId})">Stop</button>
                </div>
            </div>
        `).join('');
    }

    // Hardware testing functions
    async function testRelay(relayId, action) {
        try {
            const result = await apiCall(`/api/test/relay/${relayId}/${action}`, {
                method: 'POST'
            });
            
            showMessage(result.message, 'success');
            loadHardwareStatus(); // Refresh display
        } catch (error) {
            showMessage(`Relay test failed: ${error.message}`, 'error');
        }
    }

    async function testAllRelays() {
        if (!confirm('Test all relays? This will cycle each relay ON then OFF.')) return;

        try {
            showLoading('Testing all relays...');
            
            const relays = Object.keys(hardwareStatus.relays || {});
            for (const relayId of relays) {
                await testRelay(relayId, 'on');
                await new Promise(resolve => setTimeout(resolve, 1000));
                await testRelay(relayId, 'off');
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            showMessage('All relays tested', 'success');
        } catch (error) {
            showMessage(`Relay test failed: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    }

    async function turnOffAllRelays() {
        if (!confirm('Turn off all relays?')) return;

        try {
            showLoading('Turning off all relays...');
            
            const relays = Object.keys(hardwareStatus.relays || {});
            for (const relayId of relays) {
                await testRelay(relayId, 'off');
            }
            
            showMessage('All relays turned off', 'success');
        } catch (error) {
            showMessage(`Failed to turn off relays: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    }

    async function testPump(pumpId, amount) {
        try {
            const result = await apiCall(`/api/test/pump/${pumpId}/dispense`, {
                method: 'POST',
                body: JSON.stringify({ amount: amount })
            });
            
            showMessage(result.message, 'success');
            loadHardwareStatus(); // Refresh display
        } catch (error) {
            showMessage(`Pump test failed: ${error.message}`, 'error');
        }
    }

    function showPumpTestModal() {
        const modal = document.getElementById('pump-test-modal');
        const select = document.getElementById('test-pump-select');
        
        // Populate pump options
        select.innerHTML = '<option value="">Select Pump</option>';
        Object.entries(hardwareStatus.pumps || {}).forEach(([pumpId, pump]) => {
            select.innerHTML += `<option value="${pumpId}">${pump.name || `Pump ${pumpId}`}</option>`;
        });

        // Set up form submission
        const form = document.getElementById('pump-test-form');
        form.onsubmit = handlePumpTest;

        modal.classList.add('show');
    }

    async function handlePumpTest(event) {
        event.preventDefault();
        
        const pumpId = document.getElementById('test-pump-select').value;
        const amount = parseFloat(document.getElementById('test-amount').value);
        
        if (!pumpId) {
            showMessage('Please select a pump', 'error');
            return;
        }

        try {
            await testPump(pumpId, amount);
            closePumpTestModal();
        } catch (error) {
            showMessage(`Pump test failed: ${error.message}`, 'error');
        }
    }

    function closePumpTestModal() {
        const modal = document.getElementById('pump-test-modal');
        modal.classList.remove('show');
    }

    async function testFlow(meterId, gallons) {
        try {
            const result = await apiCall(`/api/test/flow/${meterId}/start`, {
                method: 'POST',
                body: JSON.stringify({ gallons: gallons })
            });
            
            showMessage(result.message, 'success');
            loadHardwareStatus(); // Refresh display
        } catch (error) {
            showMessage(`Flow test failed: ${error.message}`, 'error');
        }
    }

    function showFlowTestModal() {
        const modal = document.getElementById('flow-test-modal');
        const form = document.getElementById('flow-test-form');
        
        form.onsubmit = handleFlowTest;
        modal.classList.add('show');
    }

    async function handleFlowTest(event) {
        event.preventDefault();
        
        const meterId = document.getElementById('test-flow-select').value;
        const gallons = parseFloat(document.getElementById('test-gallons').value);
        
        if (!meterId) {
            showMessage('Please select a flow meter', 'error');
            return;
        }

        try {
            await testFlow(meterId, gallons);
            closeFlowTestModal();
        } catch (error) {
            showMessage(`Flow test failed: ${error.message}`, 'error');
        }
    }

    function closeFlowTestModal() {
        const modal = document.getElementById('flow-test-modal');
        modal.classList.remove('show');
    }

    // Sensor testing
    async function readSensors() {
        try {
            showLoading('Reading sensors...');
            
            const result = await apiCall('/api/test/sensors');
            
            const container = document.getElementById('sensor-readings');
            if (container && result.readings) {
                container.innerHTML = `
                    <div class="sensor-reading">
                        <span class="sensor-label">pH:</span>
                        <span class="sensor-value">${result.readings.ph?.toFixed(2) || '--'}</span>
                    </div>
                    <div class="sensor-reading">
                        <span class="sensor-label">EC:</span>
                        <span class="sensor-value">${result.readings.ec?.toFixed(2) || '--'} mS/cm</span>
                    </div>
                    <div class="sensor-timestamp">
                        Last reading: ${formatTimestamp(result.readings.timestamp)}
                    </div>
                `;
            }
            
            showMessage('Sensor readings updated', 'success');
        } catch (error) {
            showMessage(`Sensor reading failed: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    }

    function startContinuousReading() {
        if (continuousReadingInterval) {
            stopContinuousReading();
        }
        
        continuousReadingInterval = setInterval(readSensors, 5000);
        showMessage('Continuous sensor reading started', 'info');
    }

    function stopContinuousReading() {
        if (continuousReadingInterval) {
            clearInterval(continuousReadingInterval);
            continuousReadingInterval = null;
            showMessage('Continuous sensor reading stopped', 'info');
        }
    }

    function calibrateSensors() {
        showMessage('Sensor calibration not yet implemented', 'info');
    }

    // Log management
    async function loadLogs() {
        try {
            await Promise.all([
                refreshHardwareLogs(),
                refreshJobLogs()
            ]);
        } catch (error) {
            showMessage('Failed to load logs: ' + error.message, 'error');
        }
    }

    async function refreshHardwareLogs() {
        try {
            const result = await apiCall('/api/logs/hardware');
            
            const container = document.getElementById('hardware-logs');
            if (container && result.logs) {
                container.innerHTML = result.logs.slice(0, 10).map(log => `
                    <div class="log-entry">
                        <span class="log-timestamp">${formatTimestamp(log.timestamp)}</span>
                        <span class="log-component">${log.component}</span>
                        <span class="log-action">${log.action}</span>
                        <span class="log-result ${log.result}">${log.result}</span>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Failed to refresh hardware logs:', error);
        }
    }

    async function refreshJobLogs() {
        try {
            const result = await apiCall('/api/logs/jobs');
            
            const container = document.getElementById('job-logs');
            if (container && result.jobs) {
                container.innerHTML = result.jobs.slice(0, 10).map(job => `
                    <div class="log-entry">
                        <span class="log-timestamp">${formatTimestamp(job.created_at)}</span>
                        <span class="log-type">${job.job_type}</span>
                        <span class="log-tank">Tank ${job.tank_id}</span>
                        <span class="log-status ${job.status}">${job.status}</span>
                    </div>
                `).join('');
            }
        } catch (error) {
            console.error('Failed to refresh job logs:', error);
        }
    }

    function clearLogs() {
        if (!confirm('Clear all hardware logs?')) return;
        showMessage('Log clearing not yet implemented', 'info');
    }

    function exportLogs() {
        showMessage('Log export not yet implemented', 'info');
    }

    // System health
    function refreshSystemHealth() {
        // Mock system health data
        document.getElementById('cpu-usage').textContent = '15%';
        document.getElementById('memory-usage').textContent = '45%';
        document.getElementById('disk-usage').textContent = '23%';
        document.getElementById('system-temp').textContent = '42Â°C';
        
        showMessage('System health refreshed', 'success');
    }

    function runDiagnostics() {
        showMessage('Full diagnostics not yet implemented', 'info');
    }

    // Manual controls
    function resetSystem() {
        if (!confirm('Reset the entire system? This will stop all operations.')) return;
        showMessage('System reset not yet implemented', 'warning');
    }

    function restartServices() {
        if (!confirm('Restart system services? This may cause temporary interruption.')) return;
        showMessage('Service restart not yet implemented', 'warning');
    }

    function toggleMockHardware(component) {
        const checkbox = document.getElementById(`mock-${component}`);
        const enabled = checkbox.checked;
        
        showMessage(`Mock ${component} ${enabled ? 'enabled' : 'disabled'}`, 'info');
    }

    // Utility functions
    async function stopAllPumps() {
        if (!confirm('Stop all pumps?')) return;
        showMessage('Stop all pumps not yet implemented', 'info');
    }

    async function stopAllFlow() {
        if (!confirm('Stop all flow meters?')) return;
        showMessage('Stop all flow not yet implemented', 'info');
    }

    async function stopPump(pumpId) {
        showMessage(`Stop pump ${pumpId} not yet implemented`, 'info');
    }

    async function stopFlow(meterId) {
        showMessage(`Stop flow meter ${meterId} not yet implemented`, 'info');
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        const pumpModal = document.getElementById('pump-test-modal');
        const flowModal = document.getElementById('flow-test-modal');
        
        if (event.target === pumpModal) {
            closePumpTestModal();
        }
        if (event.target === flowModal) {
            closeFlowTestModal();
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        stopContinuousReading();
    });
</script>
{% endblock %}