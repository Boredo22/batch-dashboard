{% extends "base.html" %}

{% block title %}System Status - Nutrient Mixing System{% endblock %}

{% block extra_css %}
<style>
    .status-card {
        transition: all 0.3s ease;
    }
    
    .status-good { border-left: 5px solid var(--success-color); }
    .status-warning { border-left: 5px solid var(--warning-color); }
    .status-error { border-left: 5px solid var(--danger-color); }
    
    .status-value {
        font-size: 1.2em;
        font-weight: bold;
    }
    
    .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-chart-line me-2"></i>System Status</h2>
        <p class="text-muted">Real-time monitoring and system diagnostics</p>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" onclick="refreshStatus()">
            <i class="fas fa-sync-alt me-2" id="refreshIcon"></i>Refresh Status
        </button>
    </div>
</div>

<!-- Overall System Health -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card status-card status-{{ 'good' if status.system_ready else 'error' }}">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4>
                            <i class="fas fa-{{ 'check-circle text-success' if status.system_ready else 'times-circle text-danger' }}"></i>
                            System Status: {{ 'ONLINE' if status.system_ready else 'OFFLINE' }}
                        </h4>
                        <p class="text-muted mb-0">Last updated: {{ status.timestamp or 'Never' }}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="status-value text-{{ 'success' if status.system_ready else 'danger' }}">
                            {{ '✓ READY' if status.system_ready else '✗ ERROR' }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hardware Status Grid -->
<div class="row">
    <!-- Pump Status -->
    <div class="col-lg-6 mb-4">
        <div class="card status-card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-pump-medical me-2"></i>Pump Status
                </h5>
            </div>
            <div class="card-body">
                {% if hardware['pumps']['ids'] %}
                    <div class="row">
                        {% for pump_id in hardware['pumps']['ids'] %}
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ hardware['pumps']['names'][pump_id] }}</strong>
                                        <br><small class="text-muted">Pump {{ pump_id }}</small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-success">Ready</span>
                                        <br><small class="text-muted" id="pumpStatus{{ pump_id }}">Idle</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            Volume Limits: {{ hardware['limits']['pump_min_ml'] or 'N/A' }} - {{ hardware['limits']['pump_max_ml'] or 'N/A' }} ml
                        </small>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>No pumps configured</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Relay Status -->
    <div class="col-lg-6 mb-4">
        <div class="card status-card">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-toggle-on me-2"></i>Relay Status
                </h5>
            </div>
            <div class="card-body">
                {% if hardware['relays']['ids'] %}
                    <div class="row">
                        {% for relay_id in hardware['relays']['ids'] %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex justify-content-between align-items-center border-bottom pb-1">
                                <div>
                                    <strong>{{ hardware['relays']['names'][relay_id] }}</strong>
                                    <br><small class="text-muted">Relay {{ relay_id }}</small>
                                </div>
                                <div>
                                    <span class="badge bg-secondary" id="relayStatus{{ relay_id }}">OFF</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>No relays configured</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Flow Meter Status (if available) -->
{% if hardware['flow_meters']['ids'] %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card status-card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-water me-2"></i>Flow Meter Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for flow_id in hardware['flow_meters']['ids'] %}
                    <div class="col-md-4 mb-3">
                        <div class="border rounded p-3 text-center">
                            <h6>{{ hardware['flow_meters']['names'][flow_id] }}</h6>
                            <div class="status-value text-info" id="flowRate{{ flow_id }}">0.0 GPM</div>
                            <small class="text-muted" id="flowTotal{{ flow_id }}">Total: 0.0 gal</small>
                            <br><span class="badge bg-secondary mt-2" id="flowStatus{{ flow_id }}">Idle</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="text-center mt-3">
                    <small class="text-muted">
                        Maximum Flow: {{ hardware['limits']['flow_max_gallons'] or 'N/A' }} gallons
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- System Details -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card status-card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>Configuration
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <td><strong>Available Pumps:</strong></td>
                            <td>{{ hardware['pumps']['ids']|length }}</td>
                        </tr>
                        <tr>
                            <td><strong>Available Relays:</strong></td>
                            <td>{{ hardware['relays']['ids']|length }}</td>
                        </tr>
                        <tr>
                            <td><strong>Available Flow Meters:</strong></td>
                            <td>{{ hardware['flow_meters']['ids']|length }}</td>
                        </tr>
                        <tr>
                            <td><strong>System Ready:</strong></td>
                            <td>
                                <span class="badge bg-{{ 'success' if status.system_ready else 'danger' }}">
                                    {{ 'Yes' if status.system_ready else 'No' }}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card status-card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Mock Hardware
                </h5>
            </div>
            <div class="card-body">
                {% if hardware.get('mock_settings') %}
                    <table class="table table-sm">
                        <tbody>
                            {% for device, is_mock in hardware['mock_settings'].items() %}
                            <tr>
                                <td><strong>{{ device.title().replace('_', ' ') }}:</strong></td>
                                <td>
                                    <span class="badge bg-{{ 'warning' if is_mock else 'success' }}">
                                        {{ 'Mock Mode' if is_mock else 'Real Hardware' }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">No mock settings configured</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Raw Status Data (for debugging) -->
<div class="row">
    <div class="col-12">
        <div class="card status-card">
            <div class="card-header bg-dark text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-code me-2"></i>Raw Status Data
                    <button class="btn btn-sm btn-outline-light ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#rawStatus">
                        Toggle
                    </button>
                </h5>
            </div>
            <div class="card-body collapse" id="rawStatus">
                <pre class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"><code id="rawStatusData">{{ status | tojson(indent=2) }}</code></pre>
            </div>
        </div>
    </div>
</div>

<!-- Floating Refresh Button -->
<button class="btn btn-primary btn-lg refresh-btn" onclick="refreshStatus()" title="Refresh Status">
    <i class="fas fa-sync-alt" id="floatingRefreshIcon"></i>
</button>

{% endblock %}

{% block extra_js %}
<script>
    let statusRefreshInterval;
    
    async function refreshStatus() {
        const refreshIcon = document.getElementById('refreshIcon');
        const floatingRefreshIcon = document.getElementById('floatingRefreshIcon');
        
        // Show loading animation
        refreshIcon.classList.add('fa-spin');
        floatingRefreshIcon.classList.add('fa-spin');
        
        try {
            const response = await fetch('/api/status');
            const data = await response.json();
            
            if (data.success) {
                // Update raw status data
                document.getElementById('rawStatusData').textContent = JSON.stringify(data.status, null, 2);
                
                // Update individual hardware status indicators
                updateHardwareStatus(data.status);
                
                showNotification('Status refreshed successfully', 'success');
            } else {
                showNotification(`Failed to refresh status: ${data.error}`, 'danger');
            }
        } catch (error) {
            showNotification(`Error refreshing status: ${error.message}`, 'danger');
        } finally {
            // Stop loading animation
            refreshIcon.classList.remove('fa-spin');
            floatingRefreshIcon.classList.remove('fa-spin');
        }
    }
    
    function updateHardwareStatus(status) {
        // Update pump status indicators
        {% for pump_id in hardware['pumps']['ids'] %}
        const pumpStatus{{ pump_id }} = document.getElementById('pumpStatus{{ pump_id }}');
        if (pumpStatus{{ pump_id }}) {
            pumpStatus{{ pump_id }}.textContent = 'Idle'; // Default status
        }
        {% endfor %}
        
        // Update relay status indicators  
        {% for relay_id in hardware['relays']['ids'] %}
        const relayStatus{{ relay_id }} = document.getElementById('relayStatus{{ relay_id }}');
        if (relayStatus{{ relay_id }}) {
            relayStatus{{ relay_id }}.textContent = 'OFF'; // Default status
            relayStatus{{ relay_id }}.className = 'badge bg-secondary';
        }
        {% endfor %}
        
        // Update flow meter status indicators
        {% for flow_id in hardware['flow_meters']['ids'] %}
        const flowRate{{ flow_id }} = document.getElementById('flowRate{{ flow_id }}');
        const flowTotal{{ flow_id }} = document.getElementById('flowTotal{{ flow_id }}');
        const flowStatus{{ flow_id }} = document.getElementById('flowStatus{{ flow_id }}');
        
        if (flowRate{{ flow_id }}) flowRate{{ flow_id }}.textContent = '0.0 GPM';
        if (flowTotal{{ flow_id }}) flowTotal{{ flow_id }}.textContent = 'Total: 0.0 gal';
        if (flowStatus{{ flow_id }}) {
            flowStatus{{ flow_id }}.textContent = 'Idle';
            flowStatus{{ flow_id }}.className = 'badge bg-secondary mt-2';
        }
        {% endfor %}
        
        // Parse actual status from response if available
        if (status.sensors) {
            // Update with real sensor data if available
            console.log('Sensor data available:', status.sensors);
        }
        
        if (status.hardware_status) {
            // Update with real hardware status if available
            console.log('Hardware status available:', status.hardware_status);
        }
    }
    
    // Auto-refresh status every 30 seconds
    function startAutoRefresh() {
        statusRefreshInterval = setInterval(refreshStatus, 30000);
    }
    
    function stopAutoRefresh() {
        if (statusRefreshInterval) {
            clearInterval(statusRefreshInterval);
        }
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        startAutoRefresh();
    });
    
    // Clean up on page unload
    window.addEventListener('beforeunload', function() {
        stopAutoRefresh();
    });
</script>
{% endblock %}